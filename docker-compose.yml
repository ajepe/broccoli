version: '3.8'

services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    ports:
      - "8001:8001"
    environment:
      - SECRET_KEY=${SECRET_KEY:-dev-secret-key}
      - DATABASE_URL=${DATABASE_URL:-sqlite:///./odoo_cloud.db}
      - CORS_ORIGINS=${CORS_ORIGINS:-http://localhost:5173}
      - PAYSTACK_SECRET_KEY=${PAYSTACK_SECRET_KEY:-sk_test_xxx}
      - PAYSTACK_PUBLIC_KEY=${PAYSTACK_PUBLIC_KEY:-pk_test_xxx}
      - PAYSTACK_WEBHOOK_SECRET=${PAYSTACK_WEBHOOK_SECRET:-whsec_xxx}
      - S3_ACCESS_KEY=${S3_ACCESS_KEY}
      - S3_SECRET_KEY=${S3_SECRET_KEY}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASSWORD=${SMTP_PASSWORD}
      - ODOO_DATA_DIR=/data/clients
      - BACKUP_DIR=/data/backups
    volumes:
      - odoo_clients:/data/clients
      - odoo_backups:/data/backups
      - /var/run/docker.sock:/var/run/docker.sock
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "5173:80"
    environment:
      - VITE_API_URL=http://localhost:8001
    depends_on:
      - backend
    restart: unless-stopped

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./infrastructure/nginx/sites-available:/etc/nginx/sites-available:ro
      - ./infrastructure/nginx/sites-enabled:/etc/nginx/sites-enabled:ro
      - ./clients:/home/babatope/Documents/projects/saas/clients:ro
      - certbot-www:/var/www/html
    depends_on:
      - frontend
    restart: unless-stopped

volumes:
  odoo_clients:
  odoo_backups:
  certbot-www:
